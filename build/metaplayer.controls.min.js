/*
Copyright (c) 2011 RAMP Holdings, Inc.

Licensed under the MIT license: http://www.opensource.org/licenses/mit-license.php

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.
*/
(function(){var e=jQuery,i={cssPrefix:"mp-controls",leading:!0,trackIntervalMsec:5E3,clockIntervalMsec:500,revealTimeMsec:500,revealDelayMsec:500,hideDelayMsec:1500,annotationSeekOffsetSec:-1,createMarkup:!0,renderTags:!0,renderMetaq:!1,autoHide:!1,showBelow:!0},h=function(a,b){if(!(this instanceof h))return new h(a,b);this.config=e.extend(!0,{},i,b);this.container=e(this.config.container||e(a.video).parents(".metaplayer"));this.video=a.video;this.dispatcher=a.dispatcher;this.annotations=[];this.video.controls=
!1;this.config.createMarkup&&this.createMarkup();this.addDataListeners(a);this.addVideoListeners();this.addUIListeners();this.trackTimer=Ramp.timer(this.config.trackIntervalMsec);this.trackTimer.listen("time",this.render,this);this.clockTimer=Ramp.timer(this.config.clockIntervalMsec);this.clockTimer.listen("time",this.onClockTimer,this);this.revealTimer=Ramp.timer(this.config.revealDelayMsec);this.revealTimer.listen("time",this.onRevealTimer,this);this.hideTimer=Ramp.timer(this.config.hideDelayMsec);
this.hideTimer.listen("time",this.onHideTimer,this);if(this.config.showBelow)this.config.autoHide=!1,this.showBelow(!0);this.config.autoHide&&this.toggle(!1,0)};MetaPlayer.controls=function(a,b){return h(this,b)};MetaPlayer.addPlugin("controls",function(a){return h(this,a)});h.prototype={addVideoListeners:function(){var a=this;e(this.video).bind("pause play seeked seeking ended",function(b){a.onPlayStateChange(b)})},addUIListeners:function(){var a=this;this.find("play").click(function(c){a.onPlayToggle(c)});
this.find("track-knob").bind("mousedown touchstart",function(c){return a.onKnobMouseDown(c)});this.find("track-fill").bind("mousedown touchstart",function(c){return a.onKnobMouseDown(c)});this.find("track-buffer").bind("mousedown touchstart",function(c){return a.onKnobMouseDown(c)});this.find("track").bind("mousedown touchstart",function(c){return a.onKnobMouseDown(c)});e(document).bind("mouseup touchend",function(c){return a.onKnobMouseUp(c)});e(document).bind("mousemove touchmove",function(c){return a.onKnobMouseMove(c)});
var b=e(this.container);b.bind("mouseenter touchstart",function(){a.config.autoHide&&(a.hideTimer.reset(),a.revealTimer.start())});b.bind("mouseleave",function(){a.config.autoHide&&(a.revealTimer.reset(),a.hideTimer.start())})},addDataListeners:function(){var a=this.dispatcher;this.config.renderTags&&a.listen("tags",this.onTags,this);this.config.renderMetaq&&a.listen("metaq",this._onMetaq,this);a.listen("metadata",this.onMetaData,this);a.listen("search",this.onSearch,this)},onTags:function(a,b){var c=
this;e.each(b,function(a,b){e.each(b.timestamps,function(a,d){c.addAnnotation(d,null,b.term,"tag")})});this.renderAnnotations()},_onMetaq:function(a,b){var c=this;e.each(b,function(a,b){e.each(b,function(a,b){c.addAnnotation(b.start,b.end,b.text||b.term,"metaq")})});this.renderAnnotations()},onMetaData:function(){this.clearAnnotations()},onSearch:function(a,b){var c=this;this.removeAnnotations("query");e.each(b.results,function(a,b){var f=b.start,g=[];e.each(b.words,function(a,b){g.push(b.text)});
g=g.join(" ").replace(/[\r\n]/g," ");c.addAnnotation(f,null,g,"query")});this.renderAnnotations()},onClockTimer:function(){this.dragging||this.renderTime()},onPlayToggle:function(){var a=this.video;a.paused?a.play():a.pause();this.render()},onPlayStateChange:function(){this.video.paused?(this.clockTimer.reset(),this.trackTimer.reset()):(this.clockTimer.start(),this.trackTimer.start());this.render()},onKnobMouseDown:function(a){this.dragging=!0;this.find("track-knob").stop();this.onKnobMouseMove(a);
a.preventDefault();return!1},onKnobMouseUp:function(a){if(this.dragging)this.dragging=!1,this.setByMousePosition(a)},onKnobMouseMove:function(a){if(this.dragging){this.find("track-buffer");var b=this.find("track-knob"),c=this.find("track"),d=b.parent().offset(),d=a.pageX-d.left,d=Math.min(d,c.width()),d=Math.max(d,0);this.renderTime(d/c.width()*this.video.duration);b.css("left",d+"px");this.setByMousePosition(a,!0)}},setByMousePosition:function(a,b){var c=this.find("track-knob");this.find("track");
var d=c.parent(),c=c.position().left/d.width()*this.video.duration;b?this.throttledSeek(c):this.seek(c)},throttledSeek:function(a){clearTimeout(this.seekDelay);var b=this;this.seekDelay=setTimeout(function(){b.seek(a)},100)},seek:function(a){clearTimeout(this.seekDelay);this.video.currentTime=parseFloat(a);this.render()},renderTime:function(a){if(!a)a=this.video.currentTime;this.find("time-current").text(this.formatTime(a))},render:function(){var a=this.video.duration,b=this.video.currentTime;this.find("play").toggleClass(this.cssName("pause"),
!this.video.paused);this.find("time-duration").html(" / "+this.formatTime(a));this.renderAnnotations();var c=this.config.trackIntervalMsec;this.renderTime();var d;a?(d=100*(b/a),a=Math.min(100*((b+c/1E3)/a),100)):a=d=0;var b=this.find("track-fill").stop(),e=this.find("track-knob").stop();this.video.paused&&(a=d);this.video.seeking&&(c*=3);b.width(d+"%");this.dragging||e.css("left",d+"%");!this.video.paused&&this.config.leading&&!this.video.seeking&&!this.dragging&&(b.animate({width:a+"%"},c,"linear"),
e.animate({left:a+"%"},c,"linear"))},autoHide:function(a){a?this.hideTimer.start():this.hideTimer.stop();return this.config.autoHide=a},onRevealTimer:function(){this.toggle(!0);this.revealTimer.reset()},onHideTimer:function(){this.toggle(!1);this.hideTimer.reset()},toggle:function(a,b){var c=this.find();e(this.container).find(".metaplayer-video");var d=void 0==a?!c.is(":visible"):a;d&&c.toggle(!0);c.stop().animate({opacity:d?1:0},null==b?this.config.revealTimeMsec:b,function(){c.toggle(d)})},showBelow:function(a){var b=
e(this.video),c=this.find().height(),d=parseFloat(b.css("bottom"));if(a){if(null==this.__shownBelow)b.css("bottom",d+c),this.__shownBelow=c}else b.css("bottom",d-this.__shownBelow),this.__shownBelow=null},addAnnotation:function(a,b,c,d){var e=this.find("track-overlay"),f=this.create("track-marker");f.hide();var g=this;f.click(function(){return g.seek(parseFloat(a)+g.options.annotationSeekOffsetSec)});c&&f.attr("title",this.formatTime(a)+"  "+c);d&&f.addClass(this.cssName(d));e.append(f);this.annotations.push({start:a,
end:b,el:f,cssClass:d});return f},renderAnnotations:function(){var a=this.video.duration;a&&e(this.annotations).each(function(b,c){c.el.css("left",100*(c.start/a)+"%");c.end&&c.el.css("width",100*((c.end-c.start)/a)+"%");c.el.show()})},removeAnnotations:function(a){var b,c;for(b=this.annotations.length-1;0<=b;b--)c=this.annotations[b],c.cssClass==a&&(this.annotations.splice(b,1),c.el.remove())},clearAnnotations:function(){this.find("track-overlay").empty();this.annotations=[]},createMarkup:function(){var a=
this.create().appendTo(this.container),b=this.create("box");a.append(b);a=this.create("play");a.append(this.create("icon-play"));b.append(a);b.append(this.create("fullscreen"));a=this.create("time");a.append(this.create("time-current"));a.append(this.create("time-duration"));b.append(a);a=this.create("track");a.append(this.create("track-buffer"));a.append(this.create("track-fill"));a.append(this.create("track-overlay"));a.append(this.create("track-knob"));b.append(a)},formatTime:function(a){if(isNaN(a))return"&mdash;:&mdash;";
var b=function(a,b){for(var c=""+a;c.length<b;)c="0"+c;return c},c=Math.floor(a/3600),d=Math.floor(a%60),a=[b(Math.floor(a%3600/60),2),b(d,2)];c&&a.unshift(c);return a.join(":")},find:function(a){return e(this.container).find("."+this.cssName(a))},create:function(a){return e("<div></div>").addClass(this.cssName(a))},cssName:function(a){return this.config.cssPrefix+(a?"-"+a:"")}}})();
