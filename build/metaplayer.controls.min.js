/*
Copyright (c) 2011 RAMP Holdings, Inc.

Licensed under the MIT license: http://www.opensource.org/licenses/mit-license.php

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.
*/
(function(){var e=jQuery,i={cssPrefix:"metaplayer-",leading:!0,trackIntervalMsec:5E3,clockIntervalMsec:500,annotationSeekOffsetSec:-1,createMarkup:!0,renderTags:!0,renderMetaq:!1},g=function(a,b,c){if(!(this instanceof g))return new g(a,b,c);this.config=e.extend(!0,{},i,c);if(void 0==c&&a.service)b=a.service;this.service=b;b=e(this.config.container||e(a).parent());this.container=this.create("controls");b.append(this.container);"string"==typeof a&&(a=document.getElementById(a.substr(1)));this.player=
a;this.player.controls=!1;this.annotations=[];this.config.createMarkup&&this.createMarkup();this.addPlayerListeners();this.addUIListeners();this.addDataListeners();this.trackTimer=Ramp.Timer(this.config.trackIntervalMsec);this.trackTimer.listen("time",this.render,this);this.clockTimer=Ramp.Timer(this.config.clockIntervalMsec);this.clockTimer.listen("time",this.onClockTimer,this)};Ramp.controls=function(a,b){return g(a,b)};g.prototype={addPlayerListeners:function(){var a=this;e(this.player).bind("pause play seeked seeking",
function(){a.onPlayStateChange()})},onLoad:function(a){var b=this;b.clearAnnotations();e(a.jumptags).each(function(){var a=this;e(this.timestamps).each(function(){b.addAnnotation(this,null,a.term)})})},addUIListeners:function(){var a=this;this.find("play").click(function(b){a.onPlayToggle(b)});this.find("track-knob").mousedown(function(b){return a.onKnobMouseDown(b)});this.find("track-fill").mousedown(function(b){return a.onKnobMouseDown(b)});this.find("track-buffer").mousedown(function(b){return a.onKnobMouseDown(b)});
this.find("track").mousedown(function(b){return a.onKnobMouseDown(b)});e(document).mouseup(function(b){return a.onKnobMouseUp(b)});e(document).mousemove(function(b){return a.onKnobMouseMove(b)})},addDataListeners:function(){if(this.service.onMetaData){if(this.config.renderTags)this.service.onTags(this._onTags,this);if(this.config.renderMetaq)this.service.onMetaQ(this._onMetaq,this);this.service.onMediaChange(this.onMediaChange,this)}},_onTags:function(a){var b=this;e.each(a,function(a,d){e.each(d.timestamps,
function(a,c){b.addAnnotation(c,null,d.term,"tag")})});this.renderAnnotations()},_onMetaq:function(a){var b=this;e.each(a,function(a,d){e.each(d,function(a,c){b.addAnnotation(c.start,c.end,c.text||c.term,"metaq")})});this.renderAnnotations()},onMediaChange:function(){this.clearAnnotations()},onClockTimer:function(){this.dragging||this.renderTime()},onPlayToggle:function(){var a=this.player;a.paused?a.play():a.pause();this.render()},onPlayStateChange:function(){this.player.paused?(this.clockTimer.reset(),
this.trackTimer.reset()):(this.clockTimer.start(),this.trackTimer.start());this.render()},onKnobMouseDown:function(a){this.dragging=!0;this.find("track-knob").stop();this.onKnobMouseMove(a);a.preventDefault();return!1},onKnobMouseUp:function(a){if(this.dragging)this.dragging=!1,this.setByMousePosition(a)},onKnobMouseMove:function(a){if(this.dragging){this.find("track-buffer");var b=this.find("track-knob"),c=this.find("track"),d=b.parent().offset(),d=a.pageX-d.left,d=Math.min(d,c.width()),d=Math.max(d,
0);this.renderTime(d/c.width()*this.player.duration);b.css("left",d+"px");this.setByMousePosition(a,!0)}},setByMousePosition:function(a,b){var c=this.find("track-knob");this.find("track");var d=c.parent(),c=c.position().left/d.width()*this.player.duration;b?this.throttledSeek(c):this.seek(c)},throttledSeek:function(a){clearTimeout(this.seekDelay);var b=this;this.seekDelay=setTimeout(function(){b.seek(a)},100)},seek:function(a){clearTimeout(this.seekDelay);this.player.currentTime=parseFloat(a);this.render()},
renderTime:function(a){if(!a)a=this.player.currentTime;this.find("time-current").text(this.formatTime(a))},render:function(){var a=this.player.duration,b=this.player.currentTime;this.find("play").toggleClass(this.cssName("pause"),!this.player.paused);this.find("time-duration").text(" / "+this.formatTime(a));a&&this.renderAnnotations();var c=this.config.trackIntervalMsec;this.renderTime();var d=100*(b/a),a=Math.min(100*((b+c/1E3)/a),100),b=this.find("track-fill").stop(),e=this.find("track-knob").stop();
this.player.paused&&(a=d);this.player.seeking&&(c*=3);b.width(d+"%");this.dragging||e.css("left",d+"%");!this.player.paused&&this.config.leading&&!this.player.seeking&&!this.dragging&&(b.animate({width:a+"%"},c,"linear"),e.animate({left:a+"%"},c,"linear"))},addAnnotation:function(a,b,c,d){var e=this.find("track-overlay"),f=this.create("track-marker");f.hide();var h=this;f.click(function(){return h.seek(parseFloat(a)+h.options.annotationSeekOffsetSec)});c&&f.attr("title",this.formatTime(a)+"  "+c);
d&&f.addClass(this.cssName(d));e.append(f);this.annotations.push({start:a,end:b,el:f});return f},renderAnnotations:function(){var a=this.player.duration;a&&e(this.annotations).each(function(b,c){c.el.css("left",100*(c.start/a)+"%");c.end&&c.el.css("width",100*((c.end-c.start)/a)+"%");c.el.show()})},clearAnnotations:function(){this.find("track-overlay").empty();this.annotations=[]},createMarkup:function(){var a=e(this.container),b=this.create("box");a.append(b);var c=this.create("play");c.append(this.create("icon-play"));
b.append(c);b.append(this.create("fullscreen"));c=this.create("time");c.append(this.create("time-current"));c.append(this.create("time-duration"));a.append(c);a=this.create("track");a.append(this.create("track-buffer"));a.append(this.create("track-fill"));a.append(this.create("track-overlay"));a.append(this.create("track-knob"));b.append(a)},formatTime:function(a){var b=function(a,b){for(var c=""+a;c.length<b;)c="0"+c;return c},c=Math.floor(a/3600),d=Math.floor(a%60),a=[b(Math.floor(a%3600/60),2),
b(d,2)];c&&a.unshift(c);return a.join(":")},find:function(a){return e(this.container).find("."+this.cssName(a))},create:function(a){return e("<div></div>").addClass(this.cssName(a))},cssName:function(a){return this.config.cssPrefix+a}}})();
