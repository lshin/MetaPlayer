/*
Copyright (c) 2011 RAMP Holdings, Inc.

Licensed under the MIT license: http://www.opensource.org/licenses/mit-license.php

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.
*/
(function(){var c=jQuery,g={target:"",autoHide:!0,cssPrefix:"metaplayer-overlay",template:"templates/ui.overlay.tmpl.html",captions:!1,mouseDelayMsec:500,seekBeforeSec:1,hideOnEnded:!0},f=function(a,b,d){if(!(this instanceof f))return new f(a,b,d);this.config=c.extend({},g,d);if(void 0==d&&a.service)b=a.service;this.service=b;this.player=a;this.playlist=a.playlist;this.baseUrl=Ramp.Utils.Script.base("(metaplayer||ui).overlay(.min)?.js");this.nextUp=Ramp.data();this._touchDevice=/iPad|iPhone|iPod/i.test(navigator.userAgent);
this.config.container?(this.container=this.config.container,this.init()):(this.container=this.config.target||this.player.parentNode,this.createMarkup())};Ramp.overlay=function(a,b,d){return f(a,b,d)};f.prototype={init:function(){this.addUIListeners();this.addPlayerListeners();this.addPlaylistListeners();this.addPopcornListeners();this.addServiceListeners();this.onVolumeChange();this.onPlayStateChange();this.setCaptions(this.config.captions);this._touchDevice&&this.find("close-btn").show();if(Ramp.embed)this.embed=
Ramp.embed(this.find("embed"),this.service),this.find("embed").show();Ramp.social&&Ramp.social(this.find("social"),this.service)},addUIListeners:function(){var a=this;this.find("play").click(function(){a.player.play()});this.find("play").click(function(){a.player.play()});this.find("pause").click(function(){a.player.pause()});this.find("mute").click(function(){a.player.muted=!0});this.find("unmute").click(function(){a.player.muted=!1});this.find("search-btn").click(function(){a.doSearch()});this.find("search-input").keypress(function(b){13==
b.which&&a.doSearch()});this.find("close-btn").click(function(){a.toggle(!1)});this.find("results-close").click(function(){a.find("search-input").val("");a.service.search("",a.onSearchResult,a)});var b=this.find("volume-bg");c(b).bind("mousedown touchstart",function(b){a.onVolumeDragStart(b)});c(document).bind("mouseup touchend",function(b){a.onVolumeDragEnd(b)});c(document).bind("mousemove touchmove",function(b){if(a.volumeDragging)a.onVolumeDrag(b)});this.config.autoHide&&!this.config.target&&(this.find().get(0),
this._touchDevice?c(this.container).find("video").bind("touchstart",function(){a._ended||a.delayedToggle(!0)}):(b=c(this.container),b.bind("mouseenter",function(){a._ended||a.delayedToggle(!0)}),b.bind("mouseleave",function(){a._ended||a.delayedToggle(!1)})));this.find("preview").click(function(){a.playlist.next()})},addServiceListeners:function(){if(this.service.onTags)this.service.onTags(this.onTags,this)},onTags:function(a){var b=this;c.each(a,function(a,c){b.createTag(c.term)})},renderNextUp:function(){var a=
this.playlist.nextTrack();a&&(this.find("preview-thumb").attr("src",a.thumbnail),this.find("preview-title").text(a.title),this.find("next").show())},onPlaylistChange:function(){this.renderNextUp()},onTrackChange:function(){this.nextup=null;this.clearSearch();c("."+this.cssName("tag")).remove();this.find("next").hide();this.renderNextUp()},createTag:function(a){var b=this,c=this.create("tag"),e=this.create("tag-label");e.text(a);c.append(e);c.data("term",a);c.click(function(a){b.onTagClick(a)});this.find("tags").prepend(c)},
onTagClick:function(a){a=c(a.currentTarget).data().term;this.find("search-input").val('"'+a+'"');this.doSearch()},doSearch:function(){this.service.search(this.find("search-input").val(),this.onSearchResult,this)},onSearchResult:function(a){this.clearSearch();if(a.query.length){var b=0==a.results.length;this.find("results-none").toggle(b);var d=this;c.each(a.results,function(a,b){d.createResult(b)});this.find("tags").hide();this.find("results").show()}},clearSearch:function(){this.find("result-list").empty();
this.find("tags").show();this.find("results").hide()},createResult:function(a){var b=this,d=this.create("result");d.click(function(){b.player.currentTime=a.start-b.config.seekBeforeSec});var e=this.create("result-time");e.text(Ramp.Utils.Format.seconds(a.start));d.append(e);var f=this.create("result-text");d.append(f);c.each(a.words,function(a,d){var e=d.text;d.match&&(e=c("<span>"),e.addClass(b.cssName("match")),e.text(d.text));f.append(e);f.append(" ")});this.find("result-list").append(d)},addPopcornListeners:function(){if(this.player.popcorn){var a=
this;this.find("cc").click(function(){a.setCaptions(!1)});this.find("cc-off").click(function(){a.setCaptions(!0)})}},setCaptions:function(a){this.player.popcorn&&(a?this.player.popcorn.enable("subtitle"):this.player.popcorn.disable("subtitle"),this.find("cc").toggle(a),this.find("cc-off").toggle(!a))},addPlayerListeners:function(){var a=this;c(this.player).bind("canplay",function(){var b=a.player.volume;a.player.volume=0.5;0.5!=a.player.volume&&a.hideVolumeControls();a.player.volume=b});c(this.player).bind("pause play seeked seeking canplay",
function(){a.onPlayStateChange()});c(this.player).bind("ended",function(){a.onEnded()});c(this.player).bind("volumechange",function(){a.onVolumeChange()})},addPlaylistListeners:function(){this.playlist&&(this.playlist.onTrackChange(this.onTrackChange,this),this.playlist.onPlaylistChange(this.onPlaylistChange,this))},onVolumeDragStart:function(a){this.volumeDragging=!0;this.onVolumeDrag(a);a.preventDefault()},onVolumeDragEnd:function(a){if(this.volumeDragging)this.volumeDragging=!1,this.onVolumeDrag(a),
a.preventDefault()},onVolumeDrag:function(a){var b=a.originalEvent,a=a.pageX;if(b.targetTouches){if(!b.targetTouches.length)return;a=b.targetTouches[0].pageX}b=this.find("volume-bg");b=(a-b.offset().left)/b.width();0>b&&(b=0);1<b&&(b=1);this.player.muted=!1;this.player.volume=b},hideVolumeControls:function(){this.find("mute").hide();this.find("unmute").hide();this.find("volume-bg").hide()},onVolumeChange:function(){var a=this.player.muted;this.find("mute").toggle(!a);this.find("unmute").toggle(a);
a=a?0:this.player.volume;this.find("volume").width(100*a+"%")},onPlayStateChange:function(){this._ended=!1;this.player.paused?(this.find("pause").hide(),this.find("play").show()):(this.find("play").hide(),this.find("pause").show())},onEnded:function(){if(this.config.hideOnEnded)this._ended=!0,this.find().stop().height(0)},createMarkup:function(){c.ajax(this.baseUrl+this.config.template,{context:this,success:function(a){c(this.container).append(a);this.config.autoHide&&this.find().height(0);this.init()}})},
delayedToggle:function(a){this._delayed=a;var b=this;setTimeout(function(){this.__opened!=b._delayed&&b.toggle(b._delayed)},this.config.mouseDelayMsec)},toggle:function(a){this.__opened=a;var b=this.find().stop(),c=this.find("container").height();a?b.animate({height:c},500,function(){b.height("")}):b.animate({height:0},500);this.embed&&this.embed.close(0)},find:function(a){return c(this.container).find("."+this.cssName(a))},create:function(a,b){b||(b="div");return c("<"+b+">").addClass(this.cssName(a))},
cssName:function(a){return this.config.cssPrefix+(a?"-"+a:"")}}})();
